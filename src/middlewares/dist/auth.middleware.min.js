"use strict";var __decorate=this&&this.__decorate||function(t,e,n,o){var r,i=arguments.length,c=i<3?e:null===o?o=Object.getOwnPropertyDescriptor(e,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,n,o);else for(var a=t.length-1;0<=a;a--)(r=t[a])&&(c=(i<3?r(c):3<i?r(e,n,c):r(e,n))||c);return 3<i&&c&&Object.defineProperty(e,n,c),c},__awaiter=this&&this.__awaiter||function(t,c,a,u){return new(a=a||Promise)(function(e,n){function o(t){try{i(u.next(t))}catch(t){n(t)}}function r(t){try{i(u.throw(t))}catch(t){n(t)}}function i(t){t.done?e(t.value):function(e){return e instanceof a?e:new a(function(t){t(e)})}(t.value).then(o,r)}i((u=u.apply(t,c||[])).next())})},__generator=this&&this.__generator||function(n,o){var r,i,c,t,a={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,i&&(c=2&e[0]?i.return:e[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,e[1])).done)return c;switch(i=0,c&&(e=[2&e[0],c.value]),e[0]){case 0:case 1:c=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,i=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(c=0<(c=a.trys).length&&c[c.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!c||e[1]>c[0]&&e[1]<c[3])){a.label=e[1];break}if(6===e[0]&&a.label<c[1]){a.label=c[1],c=e;break}if(c&&a.label<c[2]){a.label=c[2],a.ops.push(e);break}c[2]&&a.ops.pop(),a.trys.pop();continue}e=o.call(n,a)}catch(t){e=[6,t],i=0}finally{r=c=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};exports.__esModule=!0;var common_1=require("@nestjs/common"),jwt=require("jsonwebtoken"),jwt_secret_1=require("config/jwt.secret"),decorators_1=require("@nestjs/common/decorators"),AuthMidleware=function(){function t(t){this.administratorService=t}return t.prototype.use=function(i,t,c){return __awaiter(this,void 0,void 0,function(){var e,n,o,r;return __generator(this,function(t){switch(t.label){case 0:if(!i.headers.authorization)throw new common_1.HttpException("Token not found",common_1.HttpStatus.UNAUTHORIZED);if(e=i.headers.authorization,2!==(n=e.split(" ")).length)throw new common_1.HttpException("Bad token found1",common_1.HttpStatus.UNAUTHORIZED);o=n[1];try{r=jwt.verify(o,jwt_secret_1.jwtSecret)}catch(t){throw new common_1.HttpException("Bad token found2",common_1.HttpStatus.UNAUTHORIZED)}if(!r)throw new common_1.HttpException("Bad token found2",common_1.HttpStatus.UNAUTHORIZED);if(i.ip.toString(),r.ip!==i.ip.toString())throw new common_1.HttpException("Bad token found3",common_1.HttpStatus.UNAUTHORIZED);return[4,this.administratorService.getById(r.administratorId)];case 1:if(!t.sent())throw new common_1.HttpException("Account not found",common_1.HttpStatus.UNAUTHORIZED);if((new Date).getTime()/1e3>=r.exp)throw new common_1.HttpException("the token has expired",common_1.HttpStatus.UNAUTHORIZED);return c(),[2]}})})},t=__decorate([decorators_1.Injectable()],t)}();exports.AuthMidleware=AuthMidleware;
//# sourceMappingURL=auth.middleware.min.js.map
