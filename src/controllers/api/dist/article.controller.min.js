"use strict";var __decorate=this&&this.__decorate||function(e,r,t,o){var n,i=arguments.length,a=i<3?r:null===o?o=Object.getOwnPropertyDescriptor(r,t):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,r,t,o);else for(var s=e.length-1;0<=s;s--)(n=e[s])&&(a=(i<3?n(a):3<i?n(r,t,a):n(r,t))||a);return 3<i&&a&&Object.defineProperty(r,t,a),a},__param=this&&this.__param||function(t,o){return function(e,r){o(e,r,t)}},__awaiter=this&&this.__awaiter||function(e,a,s,c){return new(s=s||Promise)(function(r,t){function o(e){try{i(c.next(e))}catch(e){t(e)}}function n(e){try{i(c.throw(e))}catch(e){t(e)}}function i(e){e.done?r(e.value):function(r){return r instanceof s?r:new s(function(e){e(r)})}(e.value).then(o,n)}i((c=c.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(t,o){var n,i,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function r(r){return function(e){return function(r){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(a=2&r[0]?i.return:r[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,r[1])).done)return a;switch(i=0,a&&(r=[2&r[0],a.value]),r[0]){case 0:case 1:a=r;break;case 4:return s.label++,{value:r[1],done:!1};case 5:s.label++,i=r[1],r=[0];continue;case 7:r=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===r[0]||2===r[0])){s=0;continue}if(3===r[0]&&(!a||r[1]>a[0]&&r[1]<a[3])){s.label=r[1];break}if(6===r[0]&&s.label<a[1]){s.label=a[1],a=r;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(r);break}a[2]&&s.ops.pop(),s.trys.pop();continue}r=o.call(t,s)}catch(e){r=[6,e],i=0}finally{n=a=0}if(5&r[0])throw r[1];return{value:r[0]?r[1]:void 0,done:!0}}([r,e])}}};exports.__esModule=!0;var common_1=require("@nestjs/common"),platform_express_1=require("@nestjs/platform-express"),crud_1=require("@nestjsx/crud"),article_entity_1=require("src/entities/article.entity"),multer_1=require("multer"),storage_config_1=require("config/storage.config"),photo_entity_1=require("src/entities/photo.entity"),api_response_class_1=require("src/misc/api.response.class"),fileType=require("file-type"),fs=require("fs"),sharp=require("sharp"),allow_to_roles_descriptor_1=require("src/misc/allow.to.roles.descriptor"),role_checker_guard_1=require("src/misc/role.checker.guard"),ArticleController=function(){function e(e,r){this.service=e,this.photoService=r}return e.prototype.createFullArticle=function(e){return this.service.createFullArticle(e)},e.prototype.editFullArticle=function(e,r){return this.service.editFullArticle(e,r)},e.prototype.uploadPhoto=function(i,a,s){return __awaiter(this,void 0,Promise,function(){var r,t,o,n;return __generator(this,function(e){switch(e.label){case 0:return s.fileFilterError?[2,new api_response_class_1.ApiResponse("error",-4002,s.fileFilterError)]:a?[4,fileType.fromFile(a.path)]:[2,new api_response_class_1.ApiResponse("error",-4002,"File not uploaded!")];case 1:return(r=e.sent())?(t=r.mime).includes("jpeg")||t.includes("png")?[4,this.createResizedImage(a,storage_config_1.StorageConfig.photo.resize.thumb)]:(fs.unlinkSync(a.path),[2,new api_response_class_1.ApiResponse("error",-4002,"Bad file content type!")]):(fs.unlinkSync(a.path),[2,new api_response_class_1.ApiResponse("error",-4002,"Cannot detect file type!")]);case 2:return e.sent(),[4,this.createResizedImage(a,storage_config_1.StorageConfig.photo.resize.small)];case 3:return e.sent(),(o=new photo_entity_1.Photo).articleId=i,o.imagePath=a.filename,[4,this.photoService.add(o)];case 4:return(n=e.sent())?[2,n]:[2,new api_response_class_1.ApiResponse("error",-4001)]}})})},e.prototype.createResizedImage=function(n,i){return __awaiter(this,void 0,void 0,function(){var r,t,o;return __generator(this,function(e){switch(e.label){case 0:return r=n.path,t=n.filename,o=storage_config_1.StorageConfig.photo.destination+i.directory+t,[4,sharp(r).resize({fit:"cover",width:i.photo.resize.width,height:i.photo.resize.height}).toFile(o)];case 1:return e.sent(),[2]}})})},e.prototype.deltePhoto=function(t,o){return __awaiter(this,void 0,void 0,function(){var r;return __generator(this,function(e){switch(e.label){case 0:return[4,this.photoService.findOne({articleId:t,photoId:o})];case 1:if(!(r=e.sent()))return[2,new api_response_class_1.ApiResponse("error",-4004,"Photo not found")];try{fs.unlinkSync(storage_config_1.StorageConfig.photo.destination+r.imagePath),fs.unlinkSync(storage_config_1.StorageConfig.photo.destination+storage_config_1.StorageConfig.photo.resize.thumb.directory+r.imagePath),fs.unlinkSync(storage_config_1.StorageConfig.photo.destination+storage_config_1.StorageConfig.photo.resize.small.directory+r.imagePath)}catch(e){}return[4,this.photoService.deleteById(o)];case 2:return 0===e.sent().affected?[2,new api_response_class_1.ApiResponse("error",-4004,"Photo not found!")]:[2,new api_response_class_1.ApiResponse("ok",0,"One photo deleted!")]}})})},__decorate([common_1.Post(),common_1.UseGuards(role_checker_guard_1.RoleCheckedGuard),allow_to_roles_descriptor_1.AllowToRoles("administrator"),__param(0,common_1.Body())],e.prototype,"createFullArticle"),__decorate([common_1.Patch(":id"),common_1.UseGuards(role_checker_guard_1.RoleCheckedGuard),allow_to_roles_descriptor_1.AllowToRoles("administrator"),__param(0,common_1.Param("id")),__param(1,common_1.Body())],e.prototype,"editFullArticle"),__decorate([common_1.Post(":id/uploadPhoto/"),common_1.UseGuards(role_checker_guard_1.RoleCheckedGuard),allow_to_roles_descriptor_1.AllowToRoles("administrator"),common_1.UseInterceptors(platform_express_1.FileInterceptor("photo",{storage:multer_1.diskStorage({destination:storage_config_1.StorageConfig.photo.destination,filename:function(e,r,t){var o=r.originalname.replace(/\s+/g,"-");o=o.replace(/[^A-z0-9\.\-]/g,"");var n=new Date,i="";i+=n.getFullYear().toString(),i+=(n.getMonth()+1).toString();var a=(i+=n.getDate().toString())+"-"+new Array(10).fill(0).map(function(e){return(9*Math.random()).toFixed(0).toString()}).join("")+"-"+o;t(null,a=a.toLocaleLowerCase())}}),fileFilter:function(e,r,t){r.originalname.toLowerCase().match(/\.(jpg|png)$/)?r.mimetype.includes("jpeg")||r.mimetype.includes("png")?t(null,!0):t(null,!(e.fileFilterError="Bad file content type!")):t(null,!(e.fileFilterError="Bad file extension!"))},limits:{files:1,fileSize:storage_config_1.StorageConfig.photo.maxSize}})),__param(0,common_1.Param("id")),__param(1,common_1.UploadedFile()),__param(2,common_1.Req())],e.prototype,"uploadPhoto"),__decorate([common_1.Delete(":articleId/deltePhoto/:photoId"),common_1.UseGuards(role_checker_guard_1.RoleCheckedGuard),allow_to_roles_descriptor_1.AllowToRoles("administrator"),__param(0,common_1.Param("articleId")),__param(1,common_1.Param("photoId"))],e.prototype,"deltePhoto"),e=__decorate([common_1.Controller("api/article"),crud_1.Crud({model:{type:article_entity_1.Article},params:{id:{field:"article_Id",type:"number",primary:!0}},query:{join:{category:{eager:!0},photos:{eager:!0},articlePrices:{eager:!0},articleFeatures:{eager:!0},features:{eager:!0}}},routes:{only:["getOneBase","getManyBase"],getOneBase:{decorators:[common_1.UseGuards(role_checker_guard_1.RoleCheckedGuard),allow_to_roles_descriptor_1.AllowToRoles("administrator","user")]}}})],e)}();function deleteById(e,r){throw new Error("Function not implemented.")}exports.ArticleController=ArticleController;
//# sourceMappingURL=article.controller.min.js.map
