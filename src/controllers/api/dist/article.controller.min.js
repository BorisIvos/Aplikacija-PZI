"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,a=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,o);else for(var s=e.length-1;0<=s;s--)(n=e[s])&&(a=(i<3?n(a):3<i?n(t,r,a):n(t,r))||a);return 3<i&&a&&Object.defineProperty(t,r,a),a},__param=this&&this.__param||function(r,o){return function(e,t){o(e,t,r)}},__awaiter=this&&this.__awaiter||function(e,a,s,l){return new(s=s||Promise)(function(t,r){function o(e){try{i(l.next(e))}catch(e){r(e)}}function n(e){try{i(l.throw(e))}catch(e){r(e)}}function i(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(o,n)}i((l=l.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(r,o){var n,i,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=o.call(r,s)}catch(e){t=[6,e],i=0}finally{n=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var common_1=require("@nestjs/common"),platform_express_1=require("@nestjs/platform-express"),crud_1=require("@nestjsx/crud"),article_entity_1=require("src/entities/article.entity"),multer_1=require("multer"),storage_config_1=require("config/storage.config"),photo_entity_1=require("src/entities/photo.entity"),api_response_class_1=require("src/misc/api.response.class"),fileType=require("file-type"),fs=require("fs"),sharp=require("sharp"),ArticleController=function(){function e(e,t){this.service=e,this.photoService=t}return e.prototype.createFullArticle=function(e){return this.service.createFullArticle(e)},e.prototype.uploadPhoto=function(i,a,s){return __awaiter(this,void 0,Promise,function(){var t,r,o,n;return __generator(this,function(e){switch(e.label){case 0:return s.fileFilterError?[2,new api_response_class_1.ApiResponse("error",-4002,s.fileFilterError)]:a?[4,fileType.fromFile(a.path)]:[2,new api_response_class_1.ApiResponse("error",-4002,"File not uploaded!")];case 1:return(t=e.sent())?(r=t.mime).includes("jpeg")||r.includes("png")?[4,this.createResizedImage(a,storage_config_1.StorageConfig.photo.resize.thumb)]:(fs.unlinkSync(a.path),[2,new api_response_class_1.ApiResponse("error",-4002,"Bad file content type!")]):(fs.unlinkSync(a.path),[2,new api_response_class_1.ApiResponse("error",-4002,"Cannot detect file type!")]);case 2:return e.sent(),[4,this.createResizedImage(a,storage_config_1.StorageConfig.photo.resize.small)];case 3:return e.sent(),(o=new photo_entity_1.Photo).articleId=i,o.imagePath=a.filename,[4,this.photoService.add(o)];case 4:return(n=e.sent())?[2,n]:[2,new api_response_class_1.ApiResponse("error",-4001)]}})})},e.prototype.createResizedImage=function(n,i){return __awaiter(this,void 0,void 0,function(){var t,r,o;return __generator(this,function(e){switch(e.label){case 0:return t=n.path,r=n.filename,o=storage_config_1.StorageConfig.photo.destination+i.directory+r,[4,sharp(t).resize({fit:"cover",width:i.photo.resize.width,height:i.photo.resize.height}).toFile(o)];case 1:return e.sent(),[2]}})})},__decorate([common_1.Post("createFull"),__param(0,common_1.Body())],e.prototype,"createFullArticle"),__decorate([common_1.Post(":id/uploadPhoto/"),common_1.UseInterceptors(platform_express_1.FileInterceptor("photo",{storage:multer_1.diskStorage({destination:storage_config_1.StorageConfig.photo.destination,filename:function(e,t,r){var o=t.originalname.replace(/\s+/g,"-");o=o.replace(/[^A-z0-9\.\-]/g,"");var n=new Date,i="";i+=n.getFullYear().toString(),i+=(n.getMonth()+1).toString();var a=(i+=n.getDate().toString())+"-"+new Array(10).fill(0).map(function(e){return(9*Math.random()).toFixed(0).toString()}).join("")+"-"+o;r(null,a=a.toLocaleLowerCase())}}),fileFilter:function(e,t,r){t.originalname.toLowerCase().match(/\.(jpg|png)$/)?t.mimetype.includes("jpeg")||t.mimetype.includes("png")?r(null,!0):r(null,!(e.fileFilterError="Bad file content type!")):r(null,!(e.fileFilterError="Bad file extension!"))},limits:{files:1,fileSize:storage_config_1.StorageConfig.photo.maxSize}})),__param(0,common_1.Param("id")),__param(1,common_1.UploadedFile()),__param(2,common_1.Req())],e.prototype,"uploadPhoto"),e=__decorate([common_1.Controller("api/article"),crud_1.Crud({model:{type:article_entity_1.Article},params:{id:{field:"articleId",type:"number",primary:!0}},query:{join:{category:{eager:!0},photos:{eager:!0},articlePrices:{eager:!0},articleFeatures:{eager:!0},features:{eager:!0}}}})],e)}();exports.ArticleController=ArticleController;
//# sourceMappingURL=article.controller.min.js.map
