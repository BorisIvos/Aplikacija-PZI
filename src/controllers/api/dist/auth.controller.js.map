{"version":3,"sources":["auth.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,yCAA6D;AAE7D,kEAA0D;AAG1D,+BAAiC;AACjC,oGAAgG;AAChG,kCAAmC;AACnC,gGAA2F;AAE3F,gDAA8C;AAI9C;IACI,wBAAmB,oBAA0C;QAA1C,yBAAoB,GAApB,oBAAoB,CAAsB;IAAE,CAAC;IAG1D,gCAAO,GAAb,UAAsB,IAA2B,EAAS,GAAY;uCAAG,OAAO;;;;4BACvD,qBAAM,IAAI,CAAC,oBAAoB,CAAC,aAAa,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAA;;wBAA3E,aAAa,GAAE,SAA4D;wBAEjF,IAAI,CAAC,aAAa,EAAE;4BAChB,sBAAO,IAAI,OAAO,CAAC,UAAA,OAAO,IAAI,OAAA,OAAO,CAAC,IAAI,gCAAW,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,CAAC,EAAxC,CAAwC,CAAC,EAAC;yBAC3E;wBAEK,YAAY,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;wBACjD,YAAY,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;wBAC7B,kBAAkB,GAAG,YAAY,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC,WAAW,EAAE,CAAC;wBAEpE,IAAG,aAAa,CAAC,YAAY,KAAK,kBAAkB,EAAC;4BACjD,sBAAO,IAAI,OAAO,CAAC,UAAA,OAAO,IAAI,OAAA,OAAO,CAAC,IAAI,gCAAW,CAAC,OAAO,EAAE,CAAC,IAAI,CAAC,CAAC,EAAxC,CAAwC,CAAC,EAAC;yBAE3E;wBASK,OAAO,GAAG,IAAI,mDAAsB,EAAE,CAAC;wBAC7C,OAAO,CAAC,eAAe,GAAG,aAAa,CAAC,eAAe,CAAC;wBACxD,OAAO,CAAC,QAAQ,GAAE,aAAa,CAAC,QAAQ,CAAC;wBACrC,IAAI,GAAG,IAAI,IAAI,EAAE,CAAC;wBACtB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,GAAG,EAAE,CAAC,CAAC;wBAC5B,cAAc,GAAG,IAAI,CAAC,OAAO,EAAE,GAAG,IAAI,CAAC;wBAC7C,OAAO,CAAC,GAAG,GAAG,cAAc,CAAC;wBAE7B,OAAO,CAAC,EAAE,GAAG,GAAG,CAAC,EAAE,CAAC,QAAQ,EAAE,CAAC;wBAC/B,OAAO,CAAC,EAAE,GAAG,GAAG,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;wBAInC,KAAK,GAAW,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,aAAa,EAAE,EAAE,sBAAS,CAAC,CAAC;wBAE3D,cAAc,GAAG,IAAI,wDAAyB,CAChD,aAAa,CAAC,eAAe,EAC7B,aAAa,CAAC,QAAQ,EACtB,KAAK,CAER,CAAC;wBAEF,sBAAO,IAAI,OAAO,CAAC,UAAA,OAAO,IAAI,OAAA,OAAO,CAAC,cAAc,CAAC,EAAvB,CAAuB,CAAC,EAAC;;;;KAE1D;IA/CD;QADC,aAAI,CAAC,OAAO,CAAC,CAAC,mCAAmC;;QACnC,WAAA,aAAI,EAAE,CAAA,EAA+B,WAAA,YAAG,EAAE,CAAA;2CA+CxD;IAnDQ,cAAc;QAD1B,mBAAU,CAAC,MAAM,CAAC;OACN,cAAc,CAqD1B;IAAD,qBAAC;CArDD,AAqDC,IAAA;AArDY,wCAAc","file":"auth.controller.js","sourcesContent":["import { Body, Controller, Post, Req } from \"@nestjs/common\";\r\nimport { LoginAdministratorDto } from \"src/dtos/administrator/login.administrator.dto\";\r\nimport { ApiResponse } from \"src/misc/api.response.class\";\r\nimport { AdministratorService } from \"src/services/administrator/administrator.service\";\r\nimport { resolve } from \"dns\";\r\nimport * as crypto from 'crypto';\r\nimport { LoginInfoAdministratorDto } from \"src/dtos/administrator/login.info.administrator.dto\";\r\nimport * as jwt from 'jsonwebtoken'\r\nimport { JwtDataAdministatorDto } from \"src/dtos/administrator/jwt.data.administrator.dto\";\r\nimport { Request} from \"express\";\r\nimport { jwtSecret } from \"config/jwt.secret\";\r\n\r\n\r\n@Controller('auth')\r\nexport class AuthController{\r\n    constructor(public administratorService: AdministratorService){}\r\n\r\n    @Post('login') //http://localhost:3000/auth/login/\r\n    async doLogin(@Body() data: LoginAdministratorDto, @Req() req: Request): Promise< LoginInfoAdministratorDto | ApiResponse>{\r\n        const administrator =await this.administratorService.getByUsername(data.username);\r\n\r\n        if (!administrator) {\r\n            return new Promise(resolve => resolve(new ApiResponse('error', -3001)));\r\n        }\r\n\r\n        const passwordHash = crypto.createHash('sha512');\r\n        passwordHash.update(data.password);\r\n        const passwordHashString = passwordHash.digest('hex').toUpperCase();\r\n\r\n        if(administrator.passwordHash !== passwordHashString){\r\n            return new Promise(resolve => resolve(new ApiResponse('error', -3002)));\r\n\r\n        }\r\n\r\n        //administratorId\r\n        // username\r\n        // token (JWT)\r\n        // TAJNI KOD\r\n        // JSON = {administratorId, username, exp, ip, ua}\r\n        //Sifrovanje (TAJNA SIFRA -> JSON) -> Sifra binarni ->BASE64\r\n        // HEX STRING\r\n        const jwtData = new JwtDataAdministatorDto();\r\n        jwtData.administratorId = administrator.administratorId;\r\n        jwtData.username =administrator.username;\r\n        let sada = new Date();\r\n        sada.setDate(sada.getDate() + 14);\r\n        const istekTimestamp = sada.getTime() / 1000;\r\n        jwtData.ext = istekTimestamp;\r\n\r\n        jwtData.ip = req.ip.toString();\r\n        jwtData.ua = req.headers[\"user-agent\"];\r\n\r\n\r\n\r\n        let token: string = jwt.sign(jwtData.toPlainObject(), jwtSecret);\r\n\r\n        const responseObject = new LoginInfoAdministratorDto(\r\n            administrator.administratorId,\r\n            administrator.username,\r\n            token\r\n            \r\n        );\r\n\r\n        return new Promise(resolve => resolve(responseObject));\r\n\r\n    }\r\n\r\n}"]}