"use strict";var __decorate=this&&this.__decorate||function(t,e,r,n){var i,a=arguments.length,c=a<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,n);else for(var o=t.length-1;0<=o;o--)(i=t[o])&&(c=(a<3?i(c):3<a?i(e,r,c):i(e,r))||c);return 3<a&&c&&Object.defineProperty(e,r,c),c},__param=this&&this.__param||function(r,n){return function(t,e){n(t,e,r)}},__awaiter=this&&this.__awaiter||function(t,c,o,s){return new(o=o||Promise)(function(e,r){function n(t){try{a(s.next(t))}catch(t){r(t)}}function i(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){t.done?e(t.value):function(e){return e instanceof o?e:new o(function(t){t(e)})}(t.value).then(n,i)}a((s=s.apply(t,c||[])).next())})},__generator=this&&this.__generator||function(r,n){var i,a,c,t,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,a&&(c=2&e[0]?a.return:e[0]?a.throw||((c=a.return)&&c.call(a),0):a.next)&&!(c=c.call(a,e[1])).done)return c;switch(a=0,c&&(e=[2&e[0],c.value]),e[0]){case 0:case 1:c=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,a=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(c=0<(c=o.trys).length&&c[c.length-1])&&(6===e[0]||2===e[0])){o=0;continue}if(3===e[0]&&(!c||e[1]>c[0]&&e[1]<c[3])){o.label=e[1];break}if(6===e[0]&&o.label<c[1]){o.label=c[1],c=e;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(e);break}c[2]&&o.ops.pop(),o.trys.pop();continue}e=n.call(r,o)}catch(t){e=[6,t],a=0}finally{i=c=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};exports.__esModule=!0;var common_1=require("@nestjs/common"),typeorm_1=require("@nestjs/typeorm"),cart_article_entity_1=require("src/entities/cart-article.entity"),cart_entity_1=require("src/entities/cart.entity"),CartService=function(){function t(t,e){this.cart=t,this.cartArticle=e}return t.prototype.getLastActiveCartByUserId=function(n){return __awaiter(this,void 0,Promise,function(){var e,r;return __generator(this,function(t){switch(t.label){case 0:return[4,this.cart.find({where:{userId:n},order:{createdAt:"DESC"},take:1,relations:["order"]})];case 1:return(e=t.sent())&&0!==e.length?null!==(r=e[0]).order?[2,null]:[2,r]:[2,null]}})})},t.prototype.createNewCartForUser=function(r){return __awaiter(this,void 0,Promise,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return(e=new cart_entity_1.Cart).userId=r,[4,this.cart.save(e)];case 1:return[2,t.sent()]}})})},t.prototype.addArticleToCart=function(r,n,i){return __awaiter(this,void 0,Promise,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.cartArticle.findOne({cartId:r,articleId:n})];case 1:return(e=t.sent())?e.quantity+=i:((e=new cart_article_entity_1.CartArticle).cartId=r,e.articleId=n,e.quantity=i),[4,this.cartArticle.save(e)];case 2:return t.sent(),[2,this.getById(r)]}})})},t.prototype.getById=function(e){return __awaiter(this,void 0,Promise,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.cart.findOne(e,{relations:["user","cartArticles","cartArticles.article","cartArticles.article.category","cartArticles.article.articlePrices"]})];case 1:return[2,t.sent()]}})})},t.prototype.changeQuantity=function(r,n,i){return __awaiter(this,void 0,Promise,function(){var e;return __generator(this,function(t){switch(t.label){case 0:return[4,this.cartArticle.findOne({cartId:r,articleId:n})];case 1:return(e=t.sent())?(e.quantity=i,0!==e.quantity?[3,3]:[4,this.cartArticle.delete(e.cartArticleId)]):[3,5];case 2:return t.sent(),[3,5];case 3:return[4,this.cartArticle.save(e)];case 4:t.sent(),t.label=5;case 5:return[4,this.getById(r)];case 6:return[2,t.sent()]}})})},t=__decorate([common_1.Injectable(),__param(0,typeorm_1.InjectRepository(cart_entity_1.Cart)),__param(1,typeorm_1.InjectRepository(cart_article_entity_1.CartArticle))],t)}();exports.CartService=CartService;
//# sourceMappingURL=cart.service.min.js.map
