{"version":3,"sources":["article.service.ts"],"names":[],"mappings":"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","file":"article.service.js","sourcesContent":["import { Injectable } from \"@nestjs/common\";\r\nimport { InjectRepository } from \"@nestjs/typeorm\";\r\nimport { TypeOrmCrudService } from \"@nestjsx/crud-typeorm\";\r\nimport { ArticleFeature } from \"src/entities/article-feuters.entity\";\r\nimport { ArticlePrice } from \"src/entities/article-price\";\r\nimport { Article } from \"src/entities/article.entity\";\r\nimport { AddArticleDto } from \"src/dtos/article/add.article.dto\";\r\nimport { ApiResponse } from \"src/misc/api.response.class\";\r\nimport { Repository } from \"typeorm/repository/Repository\";\r\nimport { EditArticleDto } from \"src/dtos/article/edit.article.dtos\";\r\nimport { last } from \"rxjs\";\r\nimport { ArticleSearchDto } from \"src/dtos/article/article.search.dto\";\r\n\r\n@Injectable()\r\nexport class ArticleService extends TypeOrmCrudService<Article> {\r\n    constructor(\r\n        @InjectRepository(Article)\r\n        private readonly article: Repository<Article>,\r\n        //// Cim se spomene neki repozitori mora se evidentirati u osnovno modulu\r\n        @InjectRepository(ArticlePrice)\r\n        private readonly articlePrice: Repository<ArticlePrice>,\r\n\r\n        @InjectRepository(ArticleFeature)\r\n        private readonly articleFeature: Repository<ArticleFeature>,\r\n    ){\r\n        super(article);\r\n\r\n    }\r\n    async createFullArticle(data: AddArticleDto): Promise<Article | ApiResponse> {\r\n        let newArticle: Article = new Article();\r\n        newArticle.name         = data.name;\r\n        newArticle.categoryId   = data.categoryId;\r\n        newArticle.excerpt      = data.excerpt;\r\n        newArticle.description  = data.description;\r\n\r\n        let savedArticle = await this.article.save(newArticle);\r\n\r\n        let newArticlePrice: ArticlePrice = new ArticlePrice();\r\n        newArticlePrice.articleId = savedArticle.articleId;\r\n        newArticlePrice.price     = data.price;\r\n\r\n        await this.articlePrice.save(newArticlePrice);\r\n\r\n        for (let feature of data.features) {\r\n            let newArticleFeature: ArticleFeature = new ArticleFeature();\r\n            newArticleFeature.articleId = savedArticle.articleId;\r\n            newArticleFeature.featureId = feature.featureId;\r\n            newArticleFeature.value     = feature.value;\r\n\r\n            await this.articleFeature.save(newArticleFeature);\r\n        }\r\n\r\n        return await this.article.findOne(savedArticle.articleId, {\r\n            relations: [\r\n                \"category\",\r\n                \"articleFeatures\",\r\n                \"features\",\r\n                \"articlePrices\",\r\n                \r\n            ]\r\n        });\r\n    }\r\n\r\n    async editFullArticle(articleId: number, data: EditArticleDto): Promise<Article | ApiResponse> {\r\n        const existingArticle: Article = await this.article.findOne(articleId, {\r\n            relations: ['articlePrices']\r\n        });\r\n\r\n        if(!existingArticle){\r\n            return new ApiResponse('error', -5001, 'Article not found.');\r\n        }\r\n\r\n        existingArticle.name        = data.name;\r\n        existingArticle.categoryId  = data.categoryId;\r\n        existingArticle.excerpt     = data.excerpt;\r\n        existingArticle.description = data.description;\r\n        existingArticle.status      = data.status;\r\n        existingArticle.isPromoted  = data.isPromoted;\r\n\r\n        const savedArticle = await this.article.save(existingArticle);\r\n        if(!savedArticle) {\r\n            return new ApiResponse('error', -5002, 'Could not save new article data');\r\n        }\r\n\r\n        \r\n\r\n        const newPriceString: string = Number(data.price).toFixed(2); /// 50.1 -> 50.10\r\n\r\n        const lastPrice = existingArticle.articlePrices[existingArticle.articlePrices.length-1].price;\r\n\r\n        const lastPriceString: string = Number(lastPrice).toFixed(2);\r\n\r\n        if(newPriceString !== lastPriceString) {\r\n            const newArticlePrice = new ArticlePrice();\r\n            newArticlePrice.articleId = articleId;\r\n            newArticlePrice.price = data.price;\r\n\r\n            const savedArticlePrice = await this.articlePrice.save(newArticlePrice);\r\n            if (!savedArticlePrice) {\r\n                return new ApiResponse( 'error', -5003, 'Could not save the new article price.');\r\n            }\r\n\r\n        }\r\n\r\n        \r\n        if (data.features !== null) {\r\n            await this.articleFeature.remove(existingArticle.articleFeatures);\r\n            for (let feature of data.features) {\r\n                let newArticleFeature: ArticleFeature = new ArticleFeature();\r\n                newArticleFeature.articleId = articleId;\r\n                newArticleFeature.featureId = feature.featureId;\r\n                newArticleFeature.value     = feature.value;\r\n    \r\n                await this.articleFeature.save(newArticleFeature);\r\n            }\r\n    \r\n        }\r\n\r\n        return await this.article.findOne(articleId, {\r\n            relations: [\r\n                \"category\",\r\n                \"articleFeatures\",\r\n                \"features\",\r\n                \"articlePrices\",\r\n                \r\n            ]\r\n        });\r\n        \r\n    }\r\n    async search(data: ArticleSearchDto): Promise<Article[] | ApiResponse> {\r\n        const builder = await this.article.createQueryBuilder(\"article\");\r\n\r\n        builder.innerJoinAndSelect(\r\n            \"article.articlePrices\",\r\n            \"ap\",\r\n            \"ap.createdAt = (SELECT MAX(ap.created_at) FROM article_price AS ap WHERE ap.article_id = article.article_id)\" // ovo nije najbolji nacin u praksi da se uradi\r\n        );\r\n\r\n        // pametnije rjesenje (zahtjeva triger_article_price_ai)\r\n        // \"app.current = 1\r\n\r\n        builder.leftJoinAndSelect(\"article.articleFeatures\", \"af\");\r\n        builder.leftJoinAndSelect(\"article.features\", \"features\");\r\n        builder.leftJoinAndSelect(\"article.photos\", \"photos\");\r\n\r\n        builder.where('article.categoryId = :catId', { catId: data.categoryId });\r\n\r\n        if (data.keywords && data.keywords.length > 0) {\r\n            builder.andWhere(`(\r\n                                article.name LIKE :kw OR\r\n                                article.excerpt LIKE :kw OR\r\n                                article.description LIKE :kw\r\n                              )`,\r\n                              { kw: '%' + data.keywords.trim() + '%' });\r\n        }\r\n\r\n        if (data.priceMin && typeof data.priceMin === 'number') {\r\n            builder.andWhere('ap.price >= :min', { min: data.priceMin });\r\n        }\r\n\r\n        if (data.priceMax && typeof data.priceMax === 'number') {\r\n            builder.andWhere('ap.price <= :max', { max: data.priceMax });\r\n        }\r\n\r\n        if (data.features && data.features.length > 0) {\r\n            for (const feature of data.features) {\r\n                builder.andWhere(\r\n                    'af.featureId = :fId AND af.value IN (:fVals)',\r\n                    {\r\n                        fId: feature.featureId,\r\n                        fVals: feature.values,\r\n                    }\r\n                );\r\n            }\r\n        }\r\n\r\n        let orderBy = 'article.name';\r\n        let orderDirection: 'ASC' | 'DESC' = 'ASC';\r\n\r\n        if (data.orderBy) {\r\n            orderBy = data.orderBy;\r\n\r\n            if (orderBy === 'price') {\r\n                orderBy = 'ap.price';\r\n            }\r\n    \r\n            if (orderBy === 'name') {\r\n                orderBy = 'article.name';\r\n            }\r\n        }\r\n\r\n        if (data.orderDirection) {\r\n            orderDirection = data.orderDirection;\r\n        }\r\n\r\n        builder.orderBy(orderBy, orderDirection);\r\n\r\n        let page = 0;\r\n        let perPage: 5 | 10 | 25 | 50 | 75 = 25;\r\n\r\n        if (data.page && typeof data.page === 'number') {\r\n            page = data.page;\r\n        }\r\n\r\n        if (data.itemsPerPage && typeof data.itemsPerPage === 'number') {\r\n            perPage = data.itemsPerPage;\r\n        }\r\n\r\n        builder.skip(page * perPage);\r\n        builder.take(perPage);\r\n        \r\n        let articles = await builder.getMany();\r\n\r\n        if (articles.length === 0) {\r\n            return new ApiResponse(\"ok\", 0, \"No articles found for these search parameters.\");\r\n        }\r\n\r\n        return articles;\r\n\r\n        /*  Ovo je radjeno inicijalno\r\n        let articleIds = await (await builder.getMany()).map(article => article.articleId);\r\n        return await this.article.find({\r\n            where: { articleId: Any(articleIds) },\r\n            relations: [\r\n                \"category\",\r\n                \"articleFeatures\",\r\n                \"features\",\r\n                \"articlePrices\",\r\n                \"photos\"\r\n            ]    \r\n        });\r\n         */\r\n    }\r\n\r\n }\r\n"]}