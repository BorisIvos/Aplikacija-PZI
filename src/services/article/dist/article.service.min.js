"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,i){var a,n=arguments.length,c=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(e,t,r,i);else for(var s=e.length-1;0<=s;s--)(a=e[s])&&(c=(n<3?a(c):3<n?a(t,r,c):a(t,r))||c);return 3<n&&c&&Object.defineProperty(t,r,c),c},__param=this&&this.__param||function(r,i){return function(e,t){i(e,t,r)}},__awaiter=this&&this.__awaiter||function(e,c,s,o){return new(s=s||Promise)(function(t,r){function i(e){try{n(o.next(e))}catch(e){r(e)}}function a(e){try{n(o.throw(e))}catch(e){r(e)}}function n(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(i,a)}n((o=o.apply(e,c||[])).next())})},__generator=this&&this.__generator||function(r,i){var a,n,c,e,s={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,n&&(c=2&t[0]?n.return:t[0]?n.throw||((c=n.return)&&c.call(n),0):n.next)&&!(c=c.call(n,t[1])).done)return c;switch(n=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,n=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(c=0<(c=s.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){s.label=t[1];break}if(6===t[0]&&s.label<c[1]){s.label=c[1],c=t;break}if(c&&s.label<c[2]){s.label=c[2],s.ops.push(t);break}c[2]&&s.ops.pop(),s.trys.pop();continue}t=i.call(r,s)}catch(e){t=[6,e],n=0}finally{a=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var common_1=require("@nestjs/common"),typeorm_1=require("@nestjs/typeorm"),crud_typeorm_1=require("@nestjsx/crud-typeorm"),article_feuters_entity_1=require("src/entities/article-feuters.entity"),article_price_1=require("src/entities/article-price"),article_entity_1=require("src/entities/article.entity"),api_response_class_1=require("src/misc/api.response.class"),ArticleService=function(a){function e(e,t,r){var i=a.call(this,e)||this;return i.article=e,i.articlePrice=t,i.articleFeature=r,i}return __extends(e,a),e.prototype.createFullArticle=function(o){return __awaiter(this,void 0,Promise,function(){var t,r,i,a,n,c,s;return __generator(this,function(e){switch(e.label){case 0:return(t=new article_entity_1.Article).name=o.name,t.categoryId=o.categoryId,t.excerpt=o.excerpt,t.description=o.description,[4,this.article.save(t)];case 1:return r=e.sent(),(i=new article_price_1.ArticlePrice).articleId=r.articleId,i.price=o.price,[4,this.articlePrice.save(i)];case 2:e.sent(),a=0,n=o.features,e.label=3;case 3:return a<n.length?(c=n[a],(s=new article_feuters_entity_1.ArticleFeature).articleId=r.articleId,s.featureId=c.featureId,s.value=c.value,[4,this.articleFeature.save(s)]):[3,6];case 4:e.sent(),e.label=5;case 5:return a++,[3,3];case 6:return[4,this.article.findOne(r.articleId,{relations:["category","articleFeatures","features","articlePrices"]})];case 7:return[2,e.sent()]}})})},e.prototype.editFullArticle=function(u,p){return __awaiter(this,void 0,Promise,function(){var t,r,i,a,n,c,s,o,l;return __generator(this,function(e){switch(e.label){case 0:return[4,this.article.findOne(u,{relations:["articlePrices"]})];case 1:return(t=e.sent())?(t.name=p.name,t.categoryId=p.categoryId,t.excerpt=p.excerpt,t.description=p.description,t.status=p.status,t.isPromoted=p.isPromoted,[4,this.article.save(t)]):[2,new api_response_class_1.ApiResponse("error",-5001,"Article not found.")];case 2:return e.sent()?(r=Number(p.price).toFixed(2),i=t.articlePrices[t.articlePrices.length-1].price,a=Number(i).toFixed(2),r===a?[3,4]:((n=new article_price_1.ArticlePrice).articleId=u,n.price=p.price,[4,this.articlePrice.save(n)])):[2,new api_response_class_1.ApiResponse("error",-5002,"Could not save new article data")];case 3:if(!e.sent())return[2,new api_response_class_1.ApiResponse("error",-5003,"Could not save the new article price.")];e.label=4;case 4:return null===p.features?[3,9]:[4,this.articleFeature.remove(t.articleFeatures)];case 5:e.sent(),c=0,s=p.features,e.label=6;case 6:return c<s.length?(o=s[c],(l=new article_feuters_entity_1.ArticleFeature).articleId=u,l.featureId=o.featureId,l.value=o.value,[4,this.articleFeature.save(l)]):[3,9];case 7:e.sent(),e.label=8;case 8:return c++,[3,6];case 9:return[4,this.article.findOne(u,{relations:["category","articleFeatures","features","articlePrices"]})];case 10:return[2,e.sent()]}})})},e.prototype.search=function(u){return __awaiter(this,void 0,Promise,function(){var t,r,i,a,n,c,s,o,l;return __generator(this,function(e){switch(e.label){case 0:return[4,this.article.createQueryBuilder("article")];case 1:if((t=e.sent()).innerJoinAndSelect("article.articlePrices","ap","ap.createdAt = (SELECT MAX(ap.created_at) FROM article_price AS ap WHERE ap.article_id = article.article_id)"),t.leftJoinAndSelect("article.articleFeatures","af"),t.leftJoinAndSelect("article.features","features"),t.leftJoinAndSelect("article.photos","photos"),t.where("article.categoryId = :catId",{catId:u.categoryId}),u.keywords&&0<u.keywords.length&&t.andWhere("(\n                                article.name LIKE :kw OR\n                                article.excerpt LIKE :kw OR\n                                article.description LIKE :kw\n                              )",{kw:"%"+u.keywords.trim()+"%"}),u.priceMin&&"number"==typeof u.priceMin&&t.andWhere("ap.price >= :min",{min:u.priceMin}),u.priceMax&&"number"==typeof u.priceMax&&t.andWhere("ap.price <= :max",{max:u.priceMax}),u.features&&0<u.features.length)for(r=0,i=u.features;r<i.length;r++)a=i[r],t.andWhere("af.featureId = :fId AND af.value IN (:fVals)",{fId:a.featureId,fVals:a.values});return n="article.name",c="ASC",u.orderBy&&("price"===(n=u.orderBy)&&(n="ap.price"),"name"===n&&(n="article.name")),u.orderDirection&&(c=u.orderDirection),t.orderBy(n,c),s=0,o=25,u.page&&"number"==typeof u.page&&(s=u.page),u.itemsPerPage&&"number"==typeof u.itemsPerPage&&(o=u.itemsPerPage),t.skip(s*o),t.take(o),[4,t.getMany()];case 2:return 0===(l=e.sent()).length?[2,new api_response_class_1.ApiResponse("ok",0,"No articles found for these search parameters.")]:[2,l]}})})},e=__decorate([common_1.Injectable(),__param(0,typeorm_1.InjectRepository(article_entity_1.Article)),__param(1,typeorm_1.InjectRepository(article_price_1.ArticlePrice)),__param(2,typeorm_1.InjectRepository(article_feuters_entity_1.ArticleFeature))],e)}(crud_typeorm_1.TypeOrmCrudService);exports.ArticleService=ArticleService;
//# sourceMappingURL=article.service.min.js.map
