"use strict";var __extends=this&&this.__extends||function(){var i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}(),__decorate=this&&this.__decorate||function(e,t,r,i){var n,c=arguments.length,a=c<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,r,i);else for(var s=e.length-1;0<=s;s--)(n=e[s])&&(a=(c<3?n(a):3<c?n(t,r,a):n(t,r))||a);return 3<c&&a&&Object.defineProperty(t,r,a),a},__param=this&&this.__param||function(r,i){return function(e,t){i(e,t,r)}},__awaiter=this&&this.__awaiter||function(e,a,s,o){return new(s=s||Promise)(function(t,r){function i(e){try{c(o.next(e))}catch(e){r(e)}}function n(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(i,n)}c((o=o.apply(e,a||[])).next())})},__generator=this&&this.__generator||function(r,i){var n,c,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,c&&(a=2&t[0]?c.return:t[0]?c.throw||((a=c.return)&&a.call(c),0):c.next)&&!(a=a.call(c,t[1])).done)return a;switch(c=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,c=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=i.call(r,s)}catch(e){t=[6,e],c=0}finally{n=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};exports.__esModule=!0;var common_1=require("@nestjs/common"),typeorm_1=require("@nestjs/typeorm"),crud_typeorm_1=require("@nestjsx/crud-typeorm"),article_feuters_entity_1=require("src/entities/article-feuters.entity"),article_price_1=require("src/entities/article-price"),article_entity_1=require("src/entities/article.entity"),api_response_class_1=require("src/misc/api.response.class"),ArticleService=function(n){function e(e,t,r){var i=n.call(this,e)||this;return i.article=e,i.articlePrice=t,i.articleFeature=r,i}return __extends(e,n),e.prototype.createFullArticle=function(o){return __awaiter(this,void 0,Promise,function(){var t,r,i,n,c,a,s;return __generator(this,function(e){switch(e.label){case 0:return(t=new article_entity_1.Article).name=o.name,t.categoryId=o.categoryId,t.excerpt=o.excerpt,t.description=o.description,[4,this.article.save(t)];case 1:return r=e.sent(),(i=new article_price_1.ArticlePrice).articleId=r.articleId,i.price=o.price,[4,this.articlePrice.save(i)];case 2:e.sent(),n=0,c=o.features,e.label=3;case 3:return n<c.length?(a=c[n],(s=new article_feuters_entity_1.ArticleFeature).articleId=r.articleId,s.featureId=a.featureId,s.value=a.value,[4,this.articleFeature.save(s)]):[3,6];case 4:e.sent(),e.label=5;case 5:return n++,[3,3];case 6:return[4,this.article.findOne(r.articleId,{relations:["category","articleFeatures","features","articlePrices"]})];case 7:return[2,e.sent()]}})})},e.prototype.editFullArticle=function(u,_){return __awaiter(this,void 0,Promise,function(){var t,r,i,n,c,a,s,o,l;return __generator(this,function(e){switch(e.label){case 0:return[4,this.article.findOne(u,{relations:["articlePrices"]})];case 1:return(t=e.sent())?(t.name=_.name,t.categoryId=_.categoryId,t.excerpt=_.excerpt,t.description=_.description,t.status=_.status,t.isPromoted=_.isPromoted,[4,this.article.save(t)]):[2,new api_response_class_1.ApiResponse("error",-5001,"Article not found.")];case 2:return e.sent()?(r=Number(_.price).toFixed(2),i=t.articlePrices[t.articlePrices.length-1].price,n=Number(i).toFixed(2),r===n?[3,4]:((c=new article_price_1.ArticlePrice).articleId=u,c.price=_.price,[4,this.articlePrice.save(c)])):[2,new api_response_class_1.ApiResponse("error",-5002,"Could not save new article data")];case 3:if(!e.sent())return[2,new api_response_class_1.ApiResponse("error",-5003,"Could not save the new article price.")];e.label=4;case 4:return null===_.features?[3,9]:[4,this.articleFeature.remove(t.articleFeatures)];case 5:e.sent(),a=0,s=_.features,e.label=6;case 6:return a<s.length?(o=s[a],(l=new article_feuters_entity_1.ArticleFeature).articleId=u,l.featureId=o.featureId,l.value=o.value,[4,this.articleFeature.save(l)]):[3,9];case 7:e.sent(),e.label=8;case 8:return a++,[3,6];case 9:return[4,this.article.findOne(u,{relations:["category","articleFeatures","features","articlePrices"]})];case 10:return[2,e.sent()]}})})},e=__decorate([common_1.Injectable(),__param(0,typeorm_1.InjectRepository(article_entity_1.Article)),__param(1,typeorm_1.InjectRepository(article_price_1.ArticlePrice)),__param(2,typeorm_1.InjectRepository(article_feuters_entity_1.ArticleFeature))],e)}(crud_typeorm_1.TypeOrmCrudService);exports.ArticleService=ArticleService;
//# sourceMappingURL=article.service.min.js.map
